# 5. Define a Service Account

Before running the pipeline, we need to set up a service account. A service account is associated with a username and can be granted roles to control access to protected resources. Our service account uses secrets containing credentials for authentication
along with RBAC-related resources for permission to create and modify relevant Kubernetes resources.

First, we need to allow access to the private container registry. For this, we need to find the endpoint of the private container registry by running the `get routes` command, and assign this endpoint to an environment variable `REGISTRY_ROUTE`. Also, define an environment variable `EMAIL` and set the value to your IBM Id, i.e. the email address you used to signup for the IBM Cloud account. This email is used by IAM to authenticate your user in your Red Hat OpenShift Kubernetes Service (ROKS) cluster on IBM Cloud.

```bash
export REGISTRY_ROUTE=$(oc get routes -n openshift-image-registry --output json | jq -r '.items[0].spec.host')
echo $REGISTRY_ROUTE

export EMAIL=<your IBM ID>
```

Using `oc whoami` and `oc whoami -t` commands to set the values for the current user's username and password, create a generic secret `ibm-registry-secret`.

```bash
$ oc create secret generic ibm-registry-secret --type="kubernetes.io/basic-auth" --from-literal=username=$(oc whoami) --from-literal=password=$(oc whoami -t)
secret/ibm-registry-secret created

oc create secret docker-registry ibm-registry-secret-2 --docker-server=$REGISTRY_ROUTE --docker-username=$(oc whoami) --docker-password=$(oc whoami -t) --docker-email=$EMAIL
```

A pipeline run can include different types of authentication. You must specify what secret to use for what URL. You must properly annotate the Secret to specify the domain for which Tekton can use it. Tekton ignores secrets that are not properly annotated. A `credential annotation key` must begin with `tekton.dev/git-` or `tekton.dev/docker-` and its value is the URL of the host for which you want Tekton to use that credential.

Create the secret,

```bash
$ oc annotate secret ibm-registry-secret tekton.dev/docker-0=$REGISTRY_ROUTE
secret/ibm-registry-secret annotated

oc annotate secret ibm-registry-secret-2 tekton.dev/docker-0=$REGISTRY_ROUTE
```

In the example above, `tekton.dev/docker-0` specifies what URL the credentials in the secret should be used for. Tekton will use the secret to both push and pull images from your registry.

Now you must create a service account using the following yaml. You can find this yaml file at [tekton/pipeline-account.yaml](https://github.com/IBM/tekton-tutorial-openshift/blob/master/tekton/pipeline-account.yaml).

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pipeline-account
secrets:
- name: ibm-registry-secret

---

apiVersion: v1
kind: Secret
metadata:
  name: kube-api-secret
  annotations:
    kubernetes.io/service-account.name: pipeline-account
type: kubernetes.io/service-account-token

---

kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: pipeline-role
rules:
- apiGroups: [""]
  resources: ["services"]
  verbs: ["get", "create", "update", "patch"]
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "create", "update", "patch"]

---

apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pipeline-role-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: pipeline-role
subjects:
- kind: ServiceAccount
  name: pipeline-account
```

This yaml creates the following Kubernetes resources:

* A ServiceAccount named `pipeline-account`. The service account references the annotated `ibm-registry-secret` secret so that the pipeline can authenticate to your private container registry when it pushes and pulls a container image.

* A Secret named `kube-api-secret` which contains a token (generated by Kubernetes) for accessing the Kubernetes API. This allows the pipeline to use `kubectl` or `oc` to talk to your cluster.

* A Role named `pipeline-role` which provides the resource-based access control permissions needed for this pipeline to create and modify Kubernetes resources, respectively services and deployments.

* And a RoleBinding named `pipeline-role-binding`, which binds the Role to your Service Account.

Apply the file to your cluster to create the service account and related resources.

```bash
$ oc apply -f tekton/pipeline-account.yaml
serviceaccount/pipeline-account created
secret/kube-api-secret created
role.rbac.authorization.k8s.io/pipeline-role created
rolebinding.rbac.authorization.k8s.io/pipeline-role-binding created
```

Our pipeline-account is now authorized to get, create, update and patch services and deployments.

